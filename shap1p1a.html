<!--
------------------------------------------------------------------------
 分子の形

 HTML(JavaScript)

 Chemistry (c) Ohtani 2025.8
----------------------------------------------------------------------
-->
<!DOctxYPE html>
<html lang="ja">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
  <meta charset="utf-8">
  <title>分子の形</title>
</head>
<body>
<p id="Molecule shape"></p>
<div style='float:left;'>
細<label><input type="range" id ="rangeA1" min="0" max= "4" step="1"
  value="0">56789<br></label>
質<label><input type="range" id ="rangeC1" min="0" max= "3" step="1"
  value="0">erty<br></label>
線<label><input type="range" id ="rangeL1" min="0" max= "4" step="1"
  value="0">asdfg<br></label>
形<label><input type="range" id ="rangeS1" min="0" max= "4" step="1"
  value="4">01234<br></label>
<pre></pre>
Rx<label><input type="range" id ="rangeRx" min="-10" max= "10" step="1"
  value="0">↓↑mi<br></label>
Ry<label><input type="range" id ="rangeRy" min="-10" max= "10" step="1"
  value="0">←→jk<br></label>
Rz<label><input type="range" id ="rangeRz" min="-10" max= "10" step="1"
  value="0">p[<br></label>
<pre></pre>
Tx<label><input type="range" id ="rangeTx" min="-1" max= "1" step="0.1"
  value="0">;]<br></label>
Ty<label><input type="range" id ="rangeTy" min="-1" max= "1" step="0.1"
  value="0">:@<br></label>
Tz<label><input type="range" id ="rangeTz" min="-2" max= "2" step="0.2"
  value="0">,. /\<br></label>
<pre></pre>
<input type="button" id="butS" value="Turn" onclick="inkey(32)">Space
<input type="button" id="butR" value="初期位置" onclick="inkey(13)">Enter
<pre></pre>
<pre></pre>
<input type="button" id="butQ" value="細"    onclick="inkey(81)">q
<input type="button" id="butW" value="太"    onclick="inkey(87)">w
<pre></pre>
<input type="button" id="butZ" value="縮"    onclick="inkey(90)">z 
<input type="button" id="butX" value="拡"    onclick="inkey(88)">x
<input type="button" id="butC" value="初"    onclick="inkey(67)">c　
<pre></pre>

<script src="https://sciencemathhub.github.io/html/tochem.js"></script>
<script src="https://sciencemathhub.github.io/html/canlib.js"></script>
<script src="https://sciencemathhub.github.io/html/raylib.js"></script>
<script>
'use strict'

//--------------------------------------------------------------------
// public letiable
//--------------------------------------------------------------------
const B = new BASIC();
const R = new RAYTRACE0();

//----------------------------------------------------------------------
// 変数
//----------------------------------------------------------------------
// Screen幅/2, 高/2, Screen-視点距離
const Times  = 1.5;
const Screen = [16*Times, 10*Times, 40*Times];
let Resol = 0;
let Refle = 0;
let Shape = 4;
let Lines = 0;
let View  = null;
let Temp; // debug

//----------------------------------------------------------------------
// Sleep
//----------------------------------------------------------------------
let SleepTimer = null;
let SleepCount = 0;

function sleeptimeout()
{
  clearTimeout(SleepTimer);
  SleepTimer = null;
  SleepCount = 2;
}
function sleeptimeset()
{
  if (SleepCount > 0) return;
  SleepTimer = setTimeout(sleeptimeout, 1000);
  SleepCount = 1;
}
function sleeptimeclr()
{
  if (SleepTimer) clearTimeout(SleepTimer);
  SleepCount = 0;
}

//----------------------------------------------------------------------
// 位置
//----------------------------------------------------------------------
function turn()
{
  let rm;
  
  rm = R.Mode;
  R.Mode = 1;
  R.Rotate(180, 0.0, 1.0, 0.0);
  View[0] = -View[0];
  View[2] = -View[2];
  R.Mode = rm;
}

function move(rx, ry, rz, tx, ty, tz)
{
  let rm;

  rm  = Math.abs(rx) + Math.abs(ry) + Math.abs(rz);
  rm += Math.abs(tx) + Math.abs(ty) + Math.abs(tz);
  if (rm == 0)
  {
    if (SleepCount == 0) { sleeptimeset(); }
    return;
  }
  else
  { sleeptimeclr(); }

  rm = R.Mode;
  R.Mode = 1;
  R.Rotate(rx, 1.0, 0.0, 0.0);
  R.Rotate(ry, 0.0, 1.0, 0.0);
  R.Rotate(rz, 0.0, 0.0, 1.0);
  View[0] += tx;
  View[1] += ty;
  View[2] += tz;
  R.Mode = rm;
}

//----------------------------------------------------------------------
// ボタン
//----------------------------------------------------------------------
let elemA1 = document.getElementById('rangeA1');
let elemC1 = document.getElementById('rangeC1');
let elemL1 = document.getElementById('rangeL1');
let elemS1 = document.getElementById('rangeS1');
let elemRx = document.getElementById('rangeRx');
let elemRy = document.getElementById('rangeRy');
let elemRz = document.getElementById('rangeRz');
let elemTx = document.getElementById('rangeTx');
let elemTy = document.getElementById('rangeTy');
let elemTz = document.getElementById('rangeTz');

function blurelem()
{
  elemA1.blur();
  elemC1.blur();
  elemL1.blur();
  elemS1.blur();
  elemRx.blur();
  elemRy.blur();
  elemRz.blur();
  elemTx.blur();
  elemTy.blur();
  elemTz.blur();
}

function blur()
{
  document.getElementById('butS').blur();
  document.getElementById('butR').blur();
  document.getElementById('butZ').blur();
  document.getElementById('butX').blur();
  document.getElementById('butC').blur();
}

function movebar()
{
  let rx, ry, rz, tx, ty, tz;

  rx = Number(elemRx.value);
  ry = Number(elemRy.value);
  rz = Number(elemRz.value);
  tx = Number(elemTx.value);
  ty = Number(elemTy.value);
  tz = Number(elemTz.value);
  move(-rx, ry, -rz, tx, ty, tz);
}

function cleabar()
{
  elemRx.value = 0;
  elemRy.value = 0;
  elemRz.value = 0;
  elemTx.value = 0;
  elemTy.value = 0;
  elemTz.value = 0;
}

function setA1(r)
{
  let w, h, A;

  Resol = r;
  elemA1.value = r;
  w = 400;
  h = 250;
  A = Math.pow(2, r);
  R.RES = [w/A, h/A, A];  //  x dots , y dots, dot size
  blurelem();
  blur();
  sleeptimeclr();
}

function setC1(r)
{
  Refle = r;
  elemC1.value = r;  
  blurelem();
  blur();
  sleeptimeclr();
}

function setL1(s)
{
  Lines = s;
  elemL1.value = s;  
  blurelem();
  blur();
  sleeptimeclr();
}

function setS1(s)
{
  Shape = s;
  elemS1.value = s;  
  blurelem();
  blur();
  sleeptimeclr();
}

function inputA1() { setA1(Number(elemA1.value)); }
elemA1.addEventListener('input', inputA1);
function inputC1() { setC1(Number(elemC1.value)); }
elemC1.addEventListener('input', inputC1);
function inputL1() { setL1(Number(elemL1.value)); }
elemL1.addEventListener('input', inputL1);
function inputS1() { setS1(Number(elemS1.value)); }
elemS1.addEventListener('input', inputS1);

//----------------------------------------------------------------------
// 位置の初期化
//----------------------------------------------------------------------
function reset()
{
  R.Identity();
  View = [0, 0, -60];
}

//----------------------------------------------------------------------
// キー入力
//----------------------------------------------------------------------
function keyon(key)
{
  let th, tt, tx, ty, tz, rr, rx, ry, rz, k;

  rr = 2; tt = 1;
  rx = 0; ry = 0; rz = 0; tx = 0; ty = 0; tz = 0; th = 1;
  k = 1;
  if (Key[ 38] || key ==  38) { rx = -rr; k = 0; } //---  ↑  機首下げ
  if (Key[ 40] || key ==  40) { rx =  rr; k = 0; } //---  ↓  機首上げ
  if (Key[ 37] || key ==  37) { ry = -rr; k = 0; } //---  ←  左旋回
  if (Key[ 39] || key ==  39) { ry =  rr; k = 0; } //---  →  右旋回
  if (Key[ 73] || key ==  73) { rx = -rr; k = 0; } //---  i   機首下げ
  if (Key[ 77] || key ==  77) { rx =  rr; k = 0; } //---  m   機首上げ
  if (Key[ 74] || key ==  74) { ry = -rr; k = 0; } //---  j   左旋回
  if (Key[ 75] || key ==  75) { ry =  rr; k = 0; } //---  k   右旋回

  if (Key[ 80] || key ==  80) { rz =  rr; k = 0; } //---  p   左傾き
  if (Key[219] || key == 219) { rz = -rr; k = 0; } //---  [   右傾き

  if (Key[191] || key == 191) { tz =  tt; k = 0; } //---  /   後に並進
  if (Key[226] || key == 226) { tz = -tt; k = 0; } //---  \(_)前に並進
  if (Key[188] || key == 188) { tz =  tt; k = 0; } //---  ,   後に並進
  if (Key[190] || key == 190) { tz = -tt; k = 0; } //---  .   前に並進

  if (Key[192] || key == 192) { ty =  tt; k = 0; } //---  @   上に並進
  if (Key[186] || key == 186) { ty = -tt; k = 0; } //---  :   下に並進
  if (Key[187] || key == 187) { tx = -tt; k = 0; } //---  ;   左に並進
  if (Key[221] || key == 221) { tx =  tt; k = 0; } //---  ]   右に並進

  if (Key[ 16]) { th =  5 ; k = 0; } //---  SHIFT 高速
  rx *= th; ry *= th; rz *= th;
  tx *= th; ty *= th; tz *= th;

  if(k) return;

  move(rx, ry, rz, tx, ty, -tz);
}

//----------------------------------------------------------------------
// キー入力
//----------------------------------------------------------------------
function inkey(key)
{
  switch (key)
  {
    case  13: reset()          ; key = 0; break; // Enter
    case  32: turn()           ; key = 0; break; // ' '
    case  81: B.lineWidth( 0.5); key = 0; break; // 'Q'
    case  87: B.lineWidth( 2  ); key = 0; break; // 'W'
    case  90: B.zooming  (-1  ); key = 0; break; // 'Z'
    case  88: B.zooming  ( 1  ); key = 0; break; // 'X'
    case  67: B.zooming  ( 0  ); key = 0; break; // 'C'
    case  48: setS1(0)         ; key = 0; break; // '0'
    case  49: setS1(1)         ; key = 0; break; // '1'
    case  50: setS1(2)         ; key = 0; break; // '2'
    case  51: setS1(3)         ; key = 0; break; // '3'
    case  52: setS1(4)         ; key = 0; break; // '4'
    case  53: setA1(0)         ; key = 0; break; // '5'
    case  54: setA1(1)         ; key = 0; break; // '6'
    case  55: setA1(2)         ; key = 0; break; // '7'
    case  56: setA1(3)         ; key = 0; break; // '8'
    case  57: setA1(4)         ; key = 0; break; // '9'
    case  69: setC1(0)         ; key = 0; break; // 'e'
    case  82: setC1(1)         ; key = 0; break; // 'r'
    case  84: setC1(2)         ; key = 0; break; // 't'
    case  89: setC1(3)         ; key = 0; break; // 'y'
    case  65: setL1(0)         ; key = 0; break; // 'a'
    case  83: setL1(1)         ; key = 0; break; // 's'
    case  68: setL1(2)         ; key = 0; break; // 'd'
    case  70: setL1(3)         ; key = 0; break; // 'f'
    case  71: setL1(4)         ; key = 0; break; // 'g'
//    default : if (keyon(key))    key = 0;
  }
  blurelem();
  blur();
  sleeptimeclr();
//  if (key == 0) return;
}

//----------------------------------------------------------------------
document.body.addEventListener('keydown', event =>
{
  inkey(event.keyCode);
});

//----------------------------------------------------------------------
// Model配置
//----------------------------------------------------------------------
function setline()
{
  let p = [];
  let x0, y0, z0, w, h, i;

  i  = R.RES[2];
  w  = R.RES[0] * i / 2;
  h  = R.RES[1] * i / 2;

  R.Product(p, [0, 0, 0]);
  z0 = Screen[2] / (Screen[2] + Math.abs(p[2]));
  x0 = p[0] / Screen[0];
  y0 = p[1] / Screen[1];
  x0 = x0 * w;
  y0 = y0 * h;
  x0 = x0 * z0;
  y0 = y0 * z0;
  return [x0 + w, h - y0];
}

function getline(L0)
{
  switch (Lines)
  {
  case 1:
    B.LINE(L0[0][0], L0[0][1], L0[1][0], L0[1][1], '#00f');
    break;
  case 2:
    B.LINE(L0[0][0], L0[0][1], L0[1][0], L0[1][1], '#00f');
    B.LINE(L0[0][0], L0[0][1], L0[2][0], L0[2][1], '#00f');
    break;
  case 3:
    B.LINE(L0[0][0], L0[0][1], L0[1][0], L0[1][1], '#00f');
    B.LINE(L0[0][0], L0[0][1], L0[2][0], L0[2][1], '#00f');
    B.LINE(L0[0][0], L0[0][1], L0[3][0], L0[3][1], '#00f');
    B.LINE(L0[1][0], L0[1][1], L0[2][0], L0[2][1], '#00f');
    B.LINE(L0[2][0], L0[2][1], L0[3][0], L0[3][1], '#00f');
    B.LINE(L0[3][0], L0[3][1], L0[1][0], L0[1][1], '#00f');
    break;
  case 4:
    B.LINE(L0[1][0], L0[1][1], L0[2][0], L0[2][1], '#00f');
    B.LINE(L0[2][0], L0[2][1], L0[3][0], L0[3][1], '#00f');
    B.LINE(L0[3][0], L0[3][1], L0[1][0], L0[1][1], '#00f');
    B.LINE(L0[1][0], L0[1][1], L0[4][0], L0[4][1], '#00f');
    B.LINE(L0[2][0], L0[2][1], L0[4][0], L0[4][1], '#00f');
    B.LINE(L0[3][0], L0[3][1], L0[4][0], L0[4][1], '#00f');
    break;
  }
}

function model()
{
  const R0 = [0.0, 0.2, 0.0, 0.2];
  const C0 = [0  , 0  , 1.3, 1.3];
  let L0 = [];
  let md, r0, r1, d3, d1, x3, y3, t, c3, xn, yn, zn, i;

  R.Sn = 0;    // Model reset
  md = R.Mode; // Push Mode

  R.Mode = 1;  // Model mode
  R.Push();
  R.Translate(View[0], View[1], View[2]);

  R.Mode = 0;  // Model mode
  R.Specular(1.0);
  R.Shininess(10.0);
  R.Reflect(0.0);
  R.Clarity(0.0);
  R.Refract(0.0);

  // 光源
  R.Diffuse(1.0, 1.0, 1.0);
  R.Push();
  R.Identity();
  R.Translate(-500, 500, 500);
  R.Sphere(2);
  R.Pop();

  r0 = 6;
  r1 = 4;
  d1 = (r0 + r1) / 3;
  d3 = d1 * 3;
  c3 = d1 * 2 * Math.sqrt(2);
  t  = Math.PI * 2 / 3;
  x3 = c3 * Math.cos(t);
  y3 = c3 * Math.sin(t);

  // 質
  R.Reflect(R0[Refle]);

  // 0
  i = C0[Refle];
  R.Refract(i);  // n
  if (i)
  {
    R.Diffuse(0.0, 0.0, 0.0);
    R.Clarity(0.8);
  }
  else
  {
    R.Diffuse(0.0, 1.0, 1.0);
    R.Clarity(0.0);
  }
  R.Push();
  R.Translate(0, 0, 0);
  L0[0] = setline();
  R.Sphere(r0);
  R.Pop();

  R.Clarity(0.0);
  R.Refract(0.0);
  // 1-4
  R.Diffuse(1.0, 1.0, 0.0);
  xn = [ c3,  x3,  x3,  0];
  yn = [  0,  y3, -y3,  0];
  zn = [-d1, -d1, -d1, d3];
  for (i = 0; i < xn.length; i++)
  {
    R.Push();
    R.Translate(xn[i], yn[i], zn[i]);
    L0[i+1] = setline();
    if (i < Shape) R.Sphere(r1);
    R.Pop();
  }

  R.Pop();
  R.Mode = md; // Pop Mode
  return L0;
}

//----------------------------------------------------------------------
// Timer
//----------------------------------------------------------------------
let Timer = null;
let Count = 0;
let Frame = 0;

function timeout()
{
  Frame = Count;
  Count = 0;
}

function timeset()
{
  Timer = setInterval(timeout, 1000);
  Count = 0;
}

//----------------------------------------------------------------------
// Idle
//----------------------------------------------------------------------
function idle()
{
  const sh =
  [
    "　　　　　", "直線形　　", "折れ線形　", "三角錐形　", "正四面体形"
  ];
  let iw, ih, iz, x, y;
  let L0;

  keyon(0);
  movebar();

  if (SleepCount < 2) B.CLS('#000');

  B.WINDOW(0, 0, 639, 399);
  B.LINEBF(0, 16, 639, 32, '#000', false);
  B.LOCATE(0, 1);
  B.COLOR('#fff');
  B.TAB(1, 0); B.PRINT(sh[Shape]);
  y = (SleepCount == 2)? 0 : Frame;
  x = String(y).length;
  B.LOCATE(73 - x, 1); B.PRINT(y + " /s"); B.CR();
  Count++;

  if (SleepCount == 2)
  {
    window.requestAnimationFrame(idle);
    return;
  }

  x =  8 * 3;
  y = 16 * 4;
  B.WINDOW(-x, -y, 639-x, 399-y);

  iw = R.RES[0]; ih = R.RES[1]; iz = R.RES[2];
  B.LINEB(-1, -1, iw*iz + 1, ih*iz + 1, '#00f');

  L0 = model();
  B.pushWidth(1);
  R.trace(Screen[0], Screen[1], Screen[2]);
  B.popWidth();
  getline(L0);

//  B.TAB(1, 0); B.PRINT(Temp); B.CR();
  window.requestAnimationFrame(idle);
}

//----------------------------------------------------------------------
// inkey
//----------------------------------------------------------------------
let Key = new Array(256);
for (let i = 0; i < 256; i++) Key[i] = 0;
window.onkeydown = function(event) { Key[event.keyCode] = 1; }
window.onkeyup   = function(event) { Key[event.keyCode] = 0; }

//----------------------------------------------------------------------
// mouse
//----------------------------------------------------------------------
function mouseDn(x, y, touch)
{
  let x1, y1;

  if (!(0 <= x && x <= canvas.width )) return 0;
  if (!(0 <= y && y <= canvas.height)) return 0;

  B.WINDOW(0, 0, 639, 399);
  x1 = B.winX(x);
  y1 = B.winY(y);

  M.ofsX(x1);
  M.ofsY(y1);
  blurelem();
  blur();
  return 1;
}

function mouseMv(x, y, touch)
{
  let x1, y1, d;

  B.WINDOW(0, 0, 639, 399);
  x1 = B.winX(x);
  y1 = B.winY(y);

  x1 -= M.ofsX('');
  y1 -= M.ofsY('');

  d  = 10;
  x1 = Math.round(x1 / d);
  y1 = Math.round(y1 / d);

  move(y1, x1, 0, 0, 0, 0);
  
  blurelem();
  blur();
}

function mouseUp(x, y, touch)
{
  blurelem();
  blur();
}

const M = new MOUSE();
M.add();
M.mosDnFunc(mouseDn);
M.mosMvFunc(mouseMv);
M.mosUpFunc(mouseUp);

//--------------------------------------------------------------------
// main
//--------------------------------------------------------------------
function main()
{
  timeset();
  idle();
}

//----------------------------------------------------------------------
// 描画関数
//----------------------------------------------------------------------
function box(x, y, w, h, c)
{
  B.LINEBF(x, y, w, h, c, false);
}

//----------------------------------------------------------------------
R.func(box);
R.init(8);
setA1(Resol);
reset();
main();
</script>
</body>
</html>
